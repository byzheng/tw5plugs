/*\
title: $:/plugins/ihm/tidgraph/utils.js
type: application/javascript
module-type: library

Internal utility functions for tidgraph plugin.

\*/
(function(){function u(d){var c=d.getBoundingClientRect(),a=document.body,b=document.documentElement,e=c.top-(d.scrollTop||window.pageYOffset||b.scrollTop||a.scrollTop)-(b.clientTop||a.clientTop||0);d=c.left-(d.scrollLeft||window.pageXOffset||b.scrollLeft||a.scrollLeft)-(b.clientLeft||a.clientLeft||0);return{top:e,left:d,width:c.width,height:c.height,right:d+c.width,bottom:e+c.height}}function y(d,c,a){var b;d=u(d);if("string"===typeof a){if(b=document.querySelector(a),null==b)return null}else a instanceof
HTMLElement&&(b=a);var e=u(b);a=e.bottom-d.top;b=e.left-d.left;var f=e.right-d.left;d=e.top-d.top;e="";switch(c.toUpperCase()){case "L":e=[Math.round(b),Math.round(a/2+d/2)];break;case "R":e=[Math.round(f),Math.round(a/2+d/2)];break;case "T":e=[Math.round(f/2+b/2),Math.round(d)];break;case "B":e=[Math.round(f/2+b/2),Math.round(a)]}return e}function w(d){return'<span style="color:green">vecmap:</span><span style="color:red">'+d+"</span>"}function z(d,c,a){var b;b=u(c);var e=u(a);b=4>e.left+e.width/
2-(b.left+b.width/2)?["R","R"]:["R","L"];e=y(d,b[0],c);d=y(d,b[1],a);var f,g,h=10;if(null==c||null==a)return w("can't connect null element");if(null==e)return w("port not found for "+c.tagName+" - "+c.innerHTML);if(null==d)return w("port not found for "+a.tagName+" - "+a.innerHTML);c=Math.abs(d[1]-e[1]);d[1]>e[1]&&(f=c/2);d[1]<e[1]&&(f=-c/2);5>c&&(f=0);"L"==b[1]&&(g=-10);"R"==b[1]&&(g=10,h=20);return'<path d="M'+e[0]+","+e[1]+" Q"+(e[0]+h)+","+e[1]+"  "+(e[0]+h)+","+(e[1]+f)+" Q"+(e[0]+h)+","+d[1]+
"  "+(d[0]+g)+","+d[1]+'" marker-end="url(#tgr-arrow)"/>'}function x(d,c){var a;switch(c.mode.toLowerCase()){case "tagging":a="[["+d+"]tagging[]]+"+c.filter;a=$tw.wiki.filterTiddlers(a);break;case "linking":a="[["+d+"]links[]!is[missing]]+"+c.filter,a=$tw.wiki.filterTiddlers(a)}return a}function A(d,c){function a(a,n){g=n;h=a;l=encodeURIComponent(g);k=encodeURIComponent(h);e=document.getElementById(c.id+"-"+l);f=document.getElementById(c.id+"-"+k);e&&f&&b.push(z(d,e,f))}var b=[],e,f,g,h,l,k;v(c.root,
function(b,c,d){(c=b.parent)&&a(b.id,c.id)},{},{skipvisited:!1});for(var r=c.outliers.length,m=0;m<r;m++)a(c.outliers[m][0],c.outliers[m][1],!0);return b.join(" ")}function v(d,c,a,b){b=b||{};var e=b.done||[],f=b.getCh||function(a){return a.collapse?[]:a.children},g=b.lvl||0,h=void 0===b.skipvisited?!0:b.skipvisited;b.leave=b.leave||!1;if(h&&-1!==e.indexOf(d))return a;e.push(d);f=f(d);h=f.length;a=a||{};b.lvl=g+1;b.done=e;if(!1===c(d,a,g))return b.leave=!0,a;for(d=0;d<h;d++)if(a=v(f[d],c,a,b),b.leave)return a;
b.lvl--;return a}function B(d,c,a,b){b=b||{};var e=b.getCh||function(a){return a.collapse?[]:a.children},f=b.getId||function(a){return a.id},g=void 0===b.skipvisited?!0:b.skipvisited,h=b.maxdepth||-1;a=a||{};var l=[],k=[],r=[],m=0;l.push(d);r[f(d)]=void 0;do{d=l.length;for(var p=0;p<d;p++){var n=l.shift(),q;q=g?-1===k.indexOf(n)?!1:!0:!1;if(!q&&!1===c(n,r[f(n)],a))return a;k.push(n);q=e(n);l=l.concat(q);q&&q.forEach(function(a){var c=r[f(a)];c?f(c)!==f(n)&&b.outlier&&b.outlier(a,n):r[f(a)]=n})}m++}while(0!==
l.length&&m<=h);return a}function C(d,c){return v(d,function(a,c){c.cnt++;return!0},{cnt:0},{skipvisited:c}).cnt-1}function p(d,c,a){if(!(this instanceof p))throw"Error: call new tnode(id="+c+")";this.parent=d;this.id=c;this.children=[];this.collapse=!1;this.widget=a}exports.buildTable=function(d,c){function a(a,b){return $tw.utils.domMaker(a,$tw.utils.extend(b,{document:c.document}))}c.id=(new Date).valueOf();var b=a("table",{"class":"ihm-tgr-table",attributes:{id:c.id+"-table"}});(function(b){var d=
$tw.wiki;v(c.root,function(g,h,l){var k=d.getTiddler(g.id);h=1+C(g,c);var r=encodeURIComponent(g.id),m;if(k){m=$tw.utils.parseStringArray(c.tooltip);for(var p=m.length,n="",q=0;q<p&&!(n=k.getFieldString(m[q]));q++);m=n}else m="";var t;k&&(t=c.nodetitle?k.getFieldString(c.nodetitle):k.hasField("caption")?k.fields.caption:k.fields.title);l>=c.startat&&(l=a("a",{"class":"tc-tiddlylink tc-tiddlylink-resolves",text:t,attributes:{href:"#"+r}}),!1===c.nocollapse&&g.children&&0<g.children.length?(t=a("a",
{"class":"ihm-tgr-collapse tc-tiddlylink",text:g.collapse?"\u2295":"\u2296"}),$tw.utils.addEventListeners(t,[{name:"click",handlerObject:g,handlerMethod:"collapseClickEvent"}]),g=a("div",{"class":"ihm-tgr-node tgr-node",children:[l,t],attributes:{id:c.id+"-"+r,title:m}})):g=a("div",{"class":"ihm-tgr-node tgr-node",children:[l],attributes:{id:c.id+"-"+r,title:m}}),g=a("td",{attributes:{rowspan:h},children:[g]}),g=a("tr",{children:[g]}),b.appendChild(g))},{},{skipvisited:!0})})(b);console.log("table=",
b);console.log("outliers=",c.outliers);return b};exports.buildSVG=function(d,c){var a=document.getElementById(c.id+"-table");if(a){var a=getComputedStyle(a),b=d.offsetHeight,e=d.offsetWidth;console.log("style=",a,"div=",d);return'<svg  xmlns="http://www.w3.org/2000/svg" height="'+b+'px" width="'+e+'px" style="overflow: visible"><defs> <marker id="tgr-arrow" viewBox="0 0 10 10" refX="1" refY="5" markerUnits="strokeWidth" orient="auto" markerWidth="8" markerHeight="6"> <polyline class="ihm-tgr-arrow tgr-arrow" points="0,0 10,5 0,10 0,5" style="opacity:1;" /></marker></defs> <g class="ihm-tgr-link tgr-link" style="overflow: visible"> '+
A(d,c)+"</g> </svg>"}};exports.isDescendant=function(d,c,a){var b;a:switch(a.mode.toLowerCase()){case "tagging":b=(b=$tw.wiki.getTiddler(d))?b.hasTag(c):!1;break a;default:b=x(c,a),b=-1!==b.indexOf(d)}if(b)return!0;c=x(c,a);b=c.length;for(var e=!1,f=0;f<b&&!(e=exports.isDescendant(d,c[f],a));f++);return e};exports.makeTidTree=function(d,c,a){a=a||{};c.outliers=[];var b=new p(void 0,d,a.widget);B(d,function(c,b,d){if(b){a:{for(var h=d.visited,l=h.length,k=0;k<l;k++)if(h[k].id===b){b=h[k];break a}b=
void 0}c=b.addChild(c,a.widget);d.visited.push(c)}return!0},{visited:[b]},{getId:function(a){return a},getCh:function(a){return x(a,c)},maxdepth:c.maxdepth,skipvisited:!0,outlier:function(a,b){c.outliers.push([a,b])}});return b};p.prototype.addChild=function(d,c){var a=new p(this,d,c);this.children.push(a);return a};p.prototype.toString=function(){return"tnode(id="+this.id+")"};p.prototype.collapseClickEvent=function(d){this.collapse=!this.collapse;console.log(this.id+" collapse=",this.collapse,this.widget);
this.widget.paint()}})();
